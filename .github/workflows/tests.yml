name: "Run unit tests"

on:
  pull_request:
    branches:
        - main

permissions:
  contents: read

jobs:
  run-unit-tests:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      checks: write
      contents: write
      pull-requests: write
      id-token: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up Python 3.13
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@b75a909f75acd358c2196fb9a5f1299a9a8868a4
        with:
          version: "0.8.19"
          python-version: "3.13"

      - name: Install dependencies
        run: |
          uv sync --group test --group dev

      - name: Run code quality checks
        run: |
          echo "🔍 Running comprehensive code quality checks..."
          echo ""

          # Ruff - Fast Python linter (replaces flake8 + isort)
          echo "🔧 Running Ruff linter checks..."
          echo "   → Checking imports, code style, common errors, and potential bugs"
          uv run ruff check ./docker
          echo "   ✅ Ruff linting passed"
          echo ""

          # Ruff formatter check
          echo "🎨 Checking Ruff formatting..."
          echo "   → Verifying consistent code style (88-character line length)"
          uv run ruff format --check ./docker
          echo "   ✅ Ruff formatting passed"
          echo ""

          # MyPy - Static type checking
          echo "🔬 Running MyPy type checking..."
          echo "   → Analyzing type hints and catching type errors"
          uv run mypy ./docker --ignore-missing-imports --show-error-codes --no-strict-optional
          echo "   ✅ MyPy type checking passed"
          echo ""

          # Bandit - Security vulnerability scanner
          echo "🔒 Running Bandit security checks..."
          echo "   → Scanning for common security issues (excluding dependencies)"
          uv run bandit -r ./docker -f json -o bandit-report.json --exclude "*/.venv/*,*/.venv/**" || true
          uv run bandit -r ./docker --severity-level medium --exclude "*/.venv/*,*/.venv/**"
          echo "   ✅ Bandit security checks passed"
          echo ""

          echo "🎉 All code quality checks completed successfully!"

      - name: Create Code Quality Summary
        run: |
          echo "## 🎯 Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All code quality checks have passed successfully! ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 🔧 **Ruff Linter** | Import organization, code style, error detection | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| 🎨 **Ruff Formatter** | Consistent code formatting (88-char line length) | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| 🔬 **MyPy** | Static type analysis and type safety | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| 🔒 **Bandit** | Security vulnerability scanning | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Run OAuth server tests
        run: |
          uv run python tests/run_tests.py --oauth --ctrf

      - name: Run MCP proxy application tests
        run: |
          uv run python tests/run_tests.py --proxy --ctrf

      - name: Publish Test Report
        if: always()
        uses: ctrf-io/github-test-reporter@646f98cfc16c6f7a0e1f6100cabe2deb95dd2eef
        with:
          report-path: './ctrf/*.json'
          summary-report: true
          github-report: true
          failed-report: true
          fail-rate-report: true
          flaky-report: true
          flaky-rate-report: true
          failed-folded-report: true
          insights-report: true
          pull-request-report: true
          pull-request: true
          collapse-large-reports: true
          overwrite-comment: true
          suite-folded-report: true
          use-suite-name: true
          group-by: 'suite'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
